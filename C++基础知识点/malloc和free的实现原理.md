# malloc 和 free 的实现原理

1. 在标准 C 库里，提供了 malloc/free 函数分配和释放内存，这两个函数的底层是由 brk、mmap、munmap 这些系统调用实现的；
2. brk 是将数据段(.data)的最高地址指针 _edata 往高地址推， mmap 是在进程的虚拟地址空间中(堆和栈中间，称为文件映射区域的地方)找一块空间的虚拟内存，这两种方式分配的都是虚拟内存，没有分配物理内存，在第一次访问已分配的虚拟地址空间的时候，发生缺页中断，操作系统负责分配物理内存，然后建立物理内存和虚拟内存直接的映射关系；
3. malloc 小于 128k 的内存直接由 brk 来分配，将 _edata 往高地址推，malloc 大于 128k 的内存，使用 mmap 分配内存，在堆和栈之间找一块空闲内存分配，brk 分配的内存需要等到高地址内存释放以后才能释放，而 mmap 分配的内存可以单独释放。当高地址空间的空闲内存超过 128k （可由M_TRIM_THRESHOLD 选项调节）时执行内紧缩操作(trim)，在上一个步骤 free 时候，发现最高地址空闲内存超过 128k 时，于是内存紧缩。
4. malloc 是从堆中申请内存，也就是函数返回的指针是指向堆里面的一块内存，操作系统有一个记录空闲内存地址的链表，当操作系统收到程序的申请时，就会遍历该链表，然后寻找第一个空间大于所申请空间的堆节点，然后就将该节点从空闲节点链表中删除，并将该节点的空间分配给程序；